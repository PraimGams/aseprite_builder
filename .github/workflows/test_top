yaml
name: Build and deploy Aseprite

on:
  schedule:
    - cron: '0 0 * * *'
  push:
    branches:
      - main
  workflow_dispatch:

env:
  BUILD_TYPE: Release

jobs:
  check-version:
    name: Check latest Aseprite release
    runs-on: ubuntu-latest
    outputs:
      download_url: ${{ steps.version_info.outputs.download_url }}
      latest_tag: ${{ steps.version_info.outputs.latest_tag }}
      should_build: ${{ steps.should_build.outputs.should_build }}
      upload_url: ${{ steps.create_release.outputs.upload_url }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Get latest version info
        id: version_info
        run: |
          response=$(curl -sL \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/aseprite/aseprite/releases/latest)
          
          latest_tag=$(echo "$response" | jq -r '.tag_name')
          echo "latest_tag=$latest_tag" >> $GITHUB_OUTPUT
          
          download_url=$(echo "$response" | jq -r '.assets[] | select(.name | test("-Source.zip$")) | .browser_download_url')
          echo "download_url=$download_url" >> $GITHUB_OUTPUT
          
          echo "$latest_tag" > latest_tag.txt

      - name: Check cached version
        id: check_cache
        uses: actions/cache@v3
        with:
          path: latest_tag.txt
          key: aseprite-${{ steps.version_info.outputs.latest_tag }}

      - name: Determine if build is needed
        id: should_build
        run: |
          if [[ "${{ steps.check_cache.outputs.cache-hit }}" != 'true' ]]; then
            echo "should_build=true" >> $GITHUB_OUTPUT
          else
            echo "should_build=false" >> $GITHUB_OUTPUT
          fi

      - name: Create GitHub Release
        if: steps.should_build.outputs.should_build == 'true'
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version_info.outputs.latest_tag }}
          name: "Aseprite ${{ steps.version_info.outputs.latest_tag }}"
          draft: true
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build:
    name: Build Aseprite
    needs: check-version
    if: ${{ needs.check-version.outputs.should_build == 'true' }}
    runs-on: ${{ matrix.os }}
    
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Download Aseprite source
        run: |
          curl -L "${{ needs.check-version.outputs.download_url }}" -o aseprite-source.zip
          unzip aseprite-source.zip -d aseprite-source
          mkdir -p aseprite
          mv aseprite-source/*/* aseprite/ 2>/dev/null || mv aseprite-source/* aseprite/

      - name: Download Skia
        run: |
          if [ "${{ matrix.os }}" = "ubuntu-latest" ]; then
            SKIA_URL="https://github.com/aseprite/skia/releases/download/m102-b858b2a2d6/Skia-Linux-Release-x64-libcxx.zip"
          elif [ "${{ matrix.os }}" = "windows-latest" ]; then
            SKIA_URL="https://github.com/aseprite/skia/releases/download/m102-b858b2a2d6/Skia-Windows-Release-x64-libcxx.zip"
          else
            SKIA_URL="https://github.com/aseprite/skia/releases/download/m102-b858b2a2d6/Skia-macOS-Release-x64-libcxx.zip"
          fi
          
          curl -L "$SKIA_URL" -o skia.zip
          unzip skia.zip -d skia

      - name: Install dependencies
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build libxcursor-dev libxi-dev libgl1-mesa-dev libfontconfig1-dev

      - name: Install dependencies (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          choco install -y cmake ninja

      - name: Install dependencies (macOS)
        if: matrix.os == 'macos-latest'
        run: |
          brew install cmake ninja

      - name: Configure CMake
        run: |
          mkdir -p aseprite/build
          cd aseprite/build
          
          if [ "${{ matrix.os }}" = "windows-latest" ]; then
            cmake -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} -DLAF_BACKEND=skia -DSKIA_DIR=../../skia -DSKIA_LIBRARY_DIR=../../skia/out/Release-x64 -G Ninja ..
          elif [ "${{ matrix.os }}" = "macos-latest" ]; then
            cmake -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} -DLAF_BACKEND=skia -DSKIA_DIR=../../skia -DSKIA_LIBRARY_DIR=../../skia/out/Release-x64 -DCMAKE_OSX_ARCHITECTURES=x86_64 -G Ninja ..
          else
            cmake -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} -DLAF_BACKEND=skia -DSKIA_DIR=../../skia -DSKIA_LIBRARY_DIR=../../skia/out/Release-x64 -G Ninja ..
          fi

      - name: Build with Ninja
        run: |
          cd aseprite/build
          ninja aseprite

      - name: Package binary
        run: |
          cd aseprite/build/bin
          if [ "${{ matrix.os }}" = "windows-latest" ]; then
            7z a -tzip "Aseprite-${{ needs.check-version.outputs.latest_tag }}-Windows.zip" *
          elif [ "${{ matrix.os }}" = "macos-latest" ]; then
            zip -r "Aseprite-${{ needs.check-version.outputs.latest_tag }}-macOS.zip" *
          else
            zip -r "Aseprite-${{ needs.check-version.outputs.latest_tag }}-Linux.zip" *
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v3
        with:
          name: asepprite-${{ matrix.os }}-${{ needs.check-version.outputs.latest_tag }}
          path: aseprite/build/bin/*.zip

      - name: Upload to Release
        uses: softprops/action-gh-release@v1
        with:
          files: aseprite/build/bin/*.zip
          tag_name: ${{ needs.check-version.outputs.latest_tag }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
